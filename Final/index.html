<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Meeting Finder</title>
	<link rel="stylesheet" href="jquery-ui-1.8.21.custom/css/ui-lightness/jquery-ui-1.8.21.custom.css">
	<style>
		.myAccordion {
			width: 50%;
			margin: auto;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
  	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.js"></script>
</head>
<body>
	<div id="myAccordion">
		<h2><a href="#one">Manual</a></h2>
		<div>
			<div>
				Location: <input type="text" id="location" name="location"/>
			</div>
			<div>
				<button id="submit" onclick="clickSubmit()">Submit!</button>
			</div>
		</div>
		<h2><a href="#two">Auto</a></h2>
		<div>
			<div class="autolocate">Try Automatic Location</div>
			<div><button id="locate" onclick="clickLocate()">Locate Me!</button></div>
		</div>
	</div>
	<div>Town: <span class="town"></span></div>
	<div>Zip Code: <span class="zip"></span></div>
	<div>Latitude: <span class="lat"></span></div>
	<div>Longitude: <span class="long"></span></div>
	<script>
		var accOpts = {
			active: false
		};
		
		function clickSubmit(){
			var locale = $("#location").val();
			var inpts = locale.split(" ");
			var inptf = inpts[0];
			for (i = 1; i < inpts.length; i++){
				inptf = inptf + "%2B" + inpts[i];
			}
		
			var locurl =
				"http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22http%3A%2F%2Fmaps.googleapis.com%2Fmaps%2Fapi%2Fgeocode%2Fjson%3Faddress%3D" 
				+ inptf + "%26sensor%3Dtrue%22&format=json&diagnostics=true";
				
			var zip = null;
			$.getJSON(locurl, function(locResponse) {
				if (locResponse.query.results.json.status == "OK" && locResponse.query.results.json.results.geometry != null){
					processLatLong(locResponse.query.results.json.results.geometry.location.lat, 
						locResponse.query.results.json.results.geometry.location.lng);
				} else {
					alert("Unable to process location! Try again or use locate me!");
				}
			});
		}
		
		function clickLocate(){
			navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
			$('div.autolocate').html("<div>Attempting geolocation...</div>");
		}
		
		//called when geolocation fails
		function successCallback(position){
			$('div.autolocate').html("<div>Geolocation Suceeded</div>");
			processLatLong(position.coords.latitude, position.coords.longitude);
		}
		
		//called when geolocation fails
		function errorCallback(error){
			alert("GeoLocation failed! " + error.message);
			$('div.autolocate').html("<div>Unable to retrieve location :-(</div>");
		}
		
		function processLatLong(lat, lng){
			$('span.lat').html(lat);
			$('span.long').html(lng);
			var zipurl =
				"http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22http%3A%2F%2Fmaps.googleapis.com%2Fmaps%2Fapi%2Fgeocode%2Fjson%3Flatlng%3D" 
				+ lat + "%2C" + lng + "%26sensor%3Dtrue%22&format=json&diagnostics=true";
			var zip = null;
			var town = null;
			var country = null;
			$.getJSON(zipurl, function(zipResponse) {
				try{
					for (var i = 0; i < zipResponse.query.results.json.results.length; i++){
						for (var j = 0; j < zipResponse.query.results.json.results[i].address_components.length; j++){
							if (zipResponse.query.results.json.results[i].address_components[j].types[0] == "country"){
								country = zipResponse.query.results.json.results[i].address_components[j].short_name;
							}
							if (zipResponse.query.results.json.results[i].address_components[j].types == "postal_code"){
								zip = zipResponse.query.results.json.results[i].address_components[j].long_name;
							}
						}
						if (zipResponse.query.results.json.results[i].types[0] == "administrative_area_level_3" ||
							zipResponse.query.results.json.results[i].types[0] == "locality"){
								town = zipResponse.query.results.json.results[i].formatted_address;
						}
					}
				} catch (err){
					//Any errors we can ignore
				}
				if (country == "US" && zip != null){
					$('span.town').html(town);
					$('span.zip').html(zip);
				} else {
					alert("Sorry! Unable to process your location.");
				}
			});
		}
		
		(function($){		
			$("#myAccordion").accordion(accOpts);
		})(jQuery);
	</script>
</body>
</html>